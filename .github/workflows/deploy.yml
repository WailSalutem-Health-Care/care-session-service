name: Build & Deploy (OKD)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install oc
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xzf oc.tar.gz
          sudo mv oc /usr/local/bin/oc

      - name: Login to OpenShift
        run: |
          oc login "${{ secrets.OPENSHIFT_SERVER }}" \
            --token="${{ secrets.OPENSHIFT_TOKEN }}" \
            --insecure-skip-tls-verify=true
          oc project "${{ secrets.OPENSHIFT_NAMESPACE }}"

      - name: Detect changed paths
        id: changes
        run: |
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
          CHANGED="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" || true)"
          echo "$CHANGED"

          if echo "$CHANGED" | grep -qE '^k8s/'; then
            echo "k8s_changed=true" >> $GITHUB_OUTPUT
          else
            echo "k8s_changed=false" >> $GITHUB_OUTPUT
          fi

          # Adjust these paths to match your repo layout
          if echo "$CHANGED" | grep -qE '^(app/|start_consumer\.py|Dockerfile|requirements\.txt|requirements-test\.txt)'; then
            echo "code_changed=true" >> $GITHUB_OUTPUT
          else
            echo "code_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Apply Kubernetes manifests (if changed)
        if: steps.changes.outputs.k8s_changed == 'true'
        run: |
          oc apply -f k8s/config/
          oc apply -f k8s/base/

      - name: Trigger OpenShift build (if code changed)
        if: steps.changes.outputs.code_changed == 'true'
        run: |
          oc start-build care-session-service --follow

      - name: Force rollout restart (only if k8s changed)
        if: steps.changes.outputs.k8s_changed == 'true'
        run: |
          oc rollout restart deployment/care-session-service